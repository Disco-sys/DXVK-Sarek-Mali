name: Universal-Mali-Legacy-Direct-Build
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build_legacy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1. INSTALL NECESSARY TOOLS (Default Compiler v10+)
      - name: Install Default Compiler
        run: |
          sudo apt-get update
          # This installs GCC 12/13 (well above your v10 requirement)
          sudo apt-get install -y g++-mingw-w64-x86-64 libvulkan-dev zstd patch
          
          # Force POSIX (The "Early Days" standard for DXVK)
          sudo update-alternatives --set x86_64-w64-mingw32-gcc /usr/bin/x86_64-w64-mingw32-gcc-posix
          sudo update-alternatives --set x86_64-w64-mingw32-g++ /usr/bin/x86_64-w64-mingw32-g++-posix

      # 2. COMPILE DIRECTLY (The "New Fork" Style)
      - name: Manual Compilation
        run: |
          mkdir -p ./build_output/x64
          
          # Flags used by early performance forks
          FLAGS="-O3 -march=x86-64 -msse -msse2 -mfpmath=sse -shared -static -static-libgcc -static-libstdc++ -w"
          # Mali-Specific environment optimizations
          OPTS="-DROMULUS_CLIP_DISTANCE=0 -DXVK_GPL_ASYNC=1"
          
          # Include all source directories manually to avoid 'missing header' errors
          INCLUDES=$(find ./src -type d | sed 's/^/-I /' | tr '\n' ' ')
          CORE_FILES=$(find ./src/util ./src/vulkan ./src/dxvk -name "*.cpp")

          # Loop through each component to build DLLs
          for part in dxgi d3d11 d3d10core d3d9 d3d8; do
            if [ -d "./src/$part" ]; then
              echo "Direct Compiling $part.dll..."
              x86_64-w64-mingw32-g++ $FLAGS $OPTS -I/usr/include -I./include $INCLUDES \
              -o ./build_output/x64/$part.dll $(find ./src/$part -name "*.cpp") $CORE_FILES
            fi
          done

      # 3. GENERATE LUDASHI PROFILE
      - name: Create WCP Package
        run: |
          echo '{"name":"DXVK Mali 1.11.0","version":"1.11.0","description":"Universal Mali build using Legacy Direct-Compile.","type":"DXVK"}' > ./build_output/profile.json
          cd build_output
          tar -I zstd -cf ../Universal_Mali_DXVK.wcp ./*

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: Universal-Mali-Build
          path: ./*.wcp
