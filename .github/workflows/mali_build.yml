name: Universal-Mali-GPL-Async-Build
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1. CLEAN TOOLSET (Ensures modern G++ v10+)
      - name: Setup Compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-mingw-w64-x86-64 patch zstd libvulkan-dev
          # Force POSIX for modern C++ threading required by GPL-Async
          sudo update-alternatives --set x86_64-w64-mingw32-gcc /usr/bin/x86_64-w64-mingw32-gcc-posix
          sudo update-alternatives --set x86_64-w64-mingw32-g++ /usr/bin/x86_64-w64-mingw32-g++-posix

      # 2. GPL-ASYNC & PERF PREP
      - name: Apply GPL-Async & Mali Fixes
        run: |
          # Inject version header to prevent fatal build errors
          mkdir -p ./src/dxvk
          echo '#define DXVK_VERSION "1.11.0-GPL-Async"' > ./src/dxvk/dxvk_version.h

          # Apply Ph42oN's GPL-Async Patch (The heart of the stutter fix)
          curl -L https://gitlab.com/Ph42oN/dxvk-gplasync/-/raw/master/patches/dxvk-gplasync-2.7.1.patch -o gpl.patch
          patch -p1 < gpl.patch || echo "Applied with Mali offsets"

      # 3. HIGH-SPEED DIRECT COMPILATION
      - name: Compile Optimized DLLs
        run: |
          mkdir -p ./build_output/x64
          
          # MALI PERFORMANCE FLAGS: 
          # -O3 (Max Speed), -ffast-math (GPU Boost), -DXVK_GPL_ASYNC (Enables Async)
          FLAGS="-O3 -march=x86-64 -ffast-math -shared -static -static-libgcc -static-libstdc++ -w"
          OPTS="-DXVK_GPL_ASYNC=1 -DROMULUS_CLIP_DISTANCE=0"
          
          # Your successful "Super-Include" recursive logic
          ALL_PATHS=$(find ./src -type d | sed 's/^/-I /' | tr '\n' ' ')
          INCLUDES="-I/usr/include -I./include -I./include/vulkan $ALL_PATHS"
          
          # Find core engine and Mali logic files
          CORE_ENGINE=$(find ./src/util ./src/vulkan ./src/dxvk -name "*.cpp")

          # Compile the "Big 5" DLLs
          for dll in dxgi d3d11 d3d10core d3d9 d3d8; do
            if [ -d "./src/$dll" ]; then
              echo "Compiling Optimized $dll.dll..."
              x86_64-w64-mingw32-g++ $FLAGS $OPTS $INCLUDES -o ./build_output/x64/$dll.dll $(find ./src/$dll -name "*.cpp") $CORE_ENGINE
            fi
          done

      # 4. PACKAGE FOR LUDASHI (WCP)
      - name: Final WCP Packaging
        run: |
          echo '{"name":"DXVK Mali GPL-Async","version":"1.11.0","author":"Disco-sys","description":"Pure Performance Mali Build with GPL-Async.","type":"DXVK"}' > ./build_output/profile.json
          cd build_output
          tar -I zstd -cf ../DXVK-Mali-GPL.wcp ./*

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: Mali-GPL-Performance-Pack
          path: ./*.wcp
